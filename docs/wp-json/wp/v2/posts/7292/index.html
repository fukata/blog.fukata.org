{"id":7292,"date":"2012-11-06T02:08:14","date_gmt":"2012-11-05T17:08:14","guid":{"rendered":"http:\/\/fukata.org\/?p=7292"},"modified":"2017-08-11T22:58:47","modified_gmt":"2017-08-11T22:58:47","slug":"mojolicious-session","status":"publish","type":"post","link":"https:\/\/blog.fukata.org\/archives\/7292\/","title":{"rendered":"Mojolicious\u306eSession\u7ba1\u7406\u306b\u3064\u3044\u3066\u8003\u3048\u3066\u307f\u305f"},"content":{"rendered":"<p>Mojolicious\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3067\u306fcookie\u306bbase64\u5316\u3057\u305f\u6587\u5b57\u5217\u3092\u683c\u7d0d\u3057\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u30014kb\u306e\u5236\u9650\u3084\u6bce\u56de\u3059\u3079\u3066\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf\u3092\u9001\u308b\u3053\u3068\u306b\u306a\u3063\u305f\u308a\u3068\u8272\u3005\u3088\u308d\u3057\u304f\u306a\u3044\u3068\u3053\u308d\u304c\u3042\u308b\u3093\u3067\u3059\u304c\u3001FW\u57fa\u76e4\u3068\u3057\u3066\u306eMojolicious\u3068\u3044\u3046\u610f\u5473\u3067\u306f\u30d7\u30e9\u30b0\u30a4\u30f3\u3067\u3069\u3046\u306b\u3067\u3082\u306a\u308b\u3088\u3046\u306a\u69cb\u9020\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u308c\u3070\u3069\u3046\u3067\u3082\u826f\u3044\u6c17\u304c\u3059\u308b\u3002<\/p>\n<p>\u305d\u3093\u306asession\u306b\u95a2\u3057\u3066\u3001\u4f7f\u3046\u6a5f\u4f1a\u304c\u3042\u3063\u305f\u306e\u3067\u5c11\u3057\u3067\u3082\u307e\u3068\u3082\u306a\u5b9f\u88c5\u3092\u63a2\u3057\u3066\u307f\u307e\u3057\u305f\u3002<\/p>\n<p><!--more--><\/p>\n<div id=\"toc_container\" class=\"no_bullets\"><p class=\"toc_title\">\u76ee\u6b21<\/p><ul class=\"toc_list\"><li><a href=\"#PlackMiddlewareMojoliciousPlugin\"><span class=\"toc_number toc_depth_1\">1<\/span> Plack::Middleware\uff1fMojolicious::Plugin\uff1f<\/a><\/li><li><a href=\"#MojoXSession\"><span class=\"toc_number toc_depth_1\">2<\/span> MojoX::Session<\/a><\/li><li><a href=\"#i\"><span class=\"toc_number toc_depth_1\">3<\/span> \u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9<\/a><\/li><li><a href=\"#Helper\"><span class=\"toc_number toc_depth_1\">4<\/span> Helper<\/a><\/li><\/ul><\/div>\n<h2><span id=\"PlackMiddlewareMojoliciousPlugin\">Plack::Middleware\uff1fMojolicious::Plugin\uff1f<\/span><\/h2>\n<p><a href=\"https:\/\/yusukebe.com\/archives\/20120225\/081052.html\" title=\"Perl\u306eWAF\u306fMojolicious\u63a8\u3057\u306a\u4ef6\u3068\u305d\u306e\u30ce\u30a6\u30cf\u30a6 - \u3086\u30fc\u3059\u3051\u3079\u30fc\u65e5\u8a18\" target=\"_blank\">Perl\u306eWAF\u306fMojolicious\u63a8\u3057\u306a\u4ef6\u3068\u305d\u306e\u30ce\u30a6\u30cf\u30a6 &#8211; \u3086\u30fc\u3059\u3051\u3079\u30fc\u65e5\u8a18<\/a><\/p>\n<p>\u3067\u3082\u66f8\u304b\u308c\u3066\u3044\u308b\u901a\u308a\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306esession\u7ba1\u7406\u306f\u4f7f\u3048\u306a\u3044\u3002\u307e\u305f\u3001\u3053\u306e\u4e2d\u3067\u306fPlack\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u6a5f\u69cb\u3092\u4f7f\u3063\u3066\u3044\u308b\u3002\u500b\u4eba\u7684\u306b\u3001\u74b0\u5883\u4f9d\u5b58\u30d5\u30a1\u30a4\u30eb\u306f\u6975\u529b\u5c11\u306a\u304f\u3057\u305f\u304b\u3063\u305f\u306e\u3067\u53ef\u80fd\u306a\u9650\u308aMojolicious::Plugin::Config\u3067\u5229\u7528\u3057\u3066\u3044\u308b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u306e\u307f\u306b\u7559\u3081\u3066\u304a\u304d\u305f\u304b\u3063\u305f\u3002<\/p>\n<p>\u305f\u3060\u3001Mojolicious\u3067\u5229\u7528\u3057\u3066\u3044\u308b\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3068\u5171\u901a\u5316\u3057\u305f\u3044\u3068\u3044\u3046\u306e\u3082\u4e0b\u8a18\u306eMojolicious::Plugin::PlackMiddleware\u3068\u3044\u3046\u306e\u3092\u4f7f\u3048\u3070\u3082\u3057\u304b\u3057\u305f\u3089\u89e3\u6c7a\u3067\u304d\u308b\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u305f\u3060\u3001\u8a66\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u306a\u3093\u3068\u3082\u8a00\u3048\u306a\u3044\u304c\u3002<\/p>\n<p><a href=\"https:\/\/search.cpan.org\/~jamadam\/Mojolicious-Plugin-PlackMiddleware-0.24\/lib\/Mojolicious\/Plugin\/PlackMiddleware.pm\" title=\"Mojolicious::Plugin::PlackMiddleware - search.cpan.org\" target=\"_blank\">Mojolicious::Plugin::PlackMiddleware &#8211; search.cpan.org<\/a><\/p>\n<h2><span id=\"MojoXSession\">MojoX::Session<\/span><\/h2>\n<p>\u4eca\u56de\u3001\u521d\u3081\u3066Mojolicious\u3092\u4f7f\u3046\u3068\u3044\u3046\u3053\u3068\u3082\u3042\u3063\u3066\u6a19\u6e96\u7684\u306a\u3082\u306e\u3092\u4f7f\u304a\u3046\u3068\u8272\u3005\u63a2\u3057\u3066\u307f\u305f\u3068\u3053\u308d\u3001MojoX::Session\u3068\u3044\u3046\u306e\u3092\u898b\u3064\u3051\u307e\u3057\u305f\u3002<\/p>\n<p><a href=\"https:\/\/search.cpan.org\/~vti\/MojoX-Session-0.25\/lib\/MojoX\/Session.pm\" title=\"MojoX::Session - search.cpan.org\" target=\"_blank\">MojoX::Session &#8211; search.cpan.org<\/a><\/p>\n<p>\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u3068\u3057\u3066Redis\u3092\u4f7f\u3063\u3066\u3044\u305f\u306e\u3067\u5f53\u7136MojoX::Session::Store::Redis\u3092\u4f7f\u3046\u3053\u3068\u306b\u3057\u307e\u3057\u305f\u3002\u5b9f\u969b\u306b\u4f7f\u3063\u3066\u307f\u308b\u3068\u30fb\u30fb\u30fb\u3002<\/p>\n<p><strong>\u5168\u7136\u52d5\u304b\u306d\u3047\uff01\uff01\uff01<\/strong><\/p>\n<p>\u306a\u3093\u3067\u52d5\u304b\u306a\u3044\u306e\u304b\u8abf\u3079\u3066\u307f\u308b\u3068\u3001Redis\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u300cHash(x14123)\u300d\u307f\u305f\u3044\u306a\u6587\u5b57\u304c\u5165\u3063\u3066\u3044\u307e\u3057\u305f\u3002\u3082\u3057\u3084\u30fb\u30fb\u30fb\u3068\u601d\u3044\u3001\u5b9f\u88c5\u3092\u898b\u3066\u307f\u308b\u3068\u3001hashref\u3092\u305d\u306e\u307e\u307e\u683c\u7d0d\u3057\u3066\u3084\u304c\u308a\u307e\u3057\u305f\u3002Redis\u306a\u3093\u3067\u305b\u3081\u3066Hash\u578b\u3068\u3057\u3066\u5165\u308c\u3066\u304f\u308c\u3066\u3044\u308c\u3070\u6700\u4f4e\u9650\u52d5\u3044\u3066\u3044\u305f\u3093\u3067\u3059\u304c\u3001\u5168\u304f\u52d5\u304b\u306a\u3044\u7a0b\u5ea6\u306e\u5b9f\u88c5\u306b\u306a\u3063\u3066\u3044\u307e\u3057\u305f\u3002<\/p>\n<p>MojoX::Session::Store\u306e\u65b9\u3067base64\u306a\u3069\u6697\u53f7\u5316\u3057\u305f\u6587\u5b57\u5217\u3092\u4e0b\u4f4d\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u6e21\u3057\u3066\u304f\u308c\u308b\u3068\u601d\u3044\u304d\u3084\u3001MojoX::Session\u306e\u5b9f\u88c5\u65b9\u91dd\u304c\u308f\u304b\u308a\u307e\u305b\u3093\u304c\u3001\u540c\u68b1\u3055\u308c\u3066\u3044\u308bMojoX::Session::Store::dbi\u306e\u5b9f\u88c5\u3092\u898b\u3066\u307f\u308b\u3068MojoX::Session::Store::dbi\u306e\u4e2d\u3067base64\u5316\u3057\u3066\u3044\u307e\u3057\u305f\u3002<\/p>\n<p>\u3053\u308c\u306f\u3001MongoDB\u306a\u3069\u30b3\u30ec\u30af\u30b7\u30e7\u30f3\u306b\u683c\u7d0d\u3059\u308b\u969b\u306b\u306f\u30c7\u30fc\u30bf\u3092\u69cb\u9020\u7684\u306b\u5165\u308c\u308c\u308b\u305f\u3081\u3078\u306e\u914d\u616e\u306a\u3093\u3060\u308d\u3046\u3068\u601d\u3044\u3001Redis\u306e\u65b9\u3067\u306fjson\u5316\u3057\u305f\u3082\u306e\u3092\u7a81\u3063\u8fbc\u3080\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002\u672c\u5bb6\u306e\u65b9\u306bPull Request\u306f\u9001\u3063\u305f\u3093\u3067\u3059\u304c\u307e\u3060\u53d6\u308a\u8fbc\u307e\u308c\u308b\u6c17\u914d\u306f\u3042\u308a\u307e\u305b\u3093\u3002<\/p>\n<p>\u73fe\u5728\u307e\u3067\u306e\u5b9f\u88c5\u306fgithub\u3078\u30a2\u30c3\u30d7\u3057\u3066\u3044\u307e\u3059\u3002<\/p>\n<p><a href=\"https:\/\/github.com\/fukata\/p5-MojoX-Session-Store-Redis\" title=\"fukata\/p5-MojoX-Session-Store-Redis\" target=\"_blank\">fukata\/p5-MojoX-Session-Store-Redis<\/a><\/p>\n<p>json\u5316\u3059\u308b\u306e\u3068Redis\u306e\u30ad\u30fc\u81ea\u4f53\u306b\u3082expire\u3092\u9069\u7528\u3059\u308b\u3088\u3046\u306b\u3082\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u3059\u3002<\/p>\n<h2><span id=\"i\">\u30a4\u30f3\u30bf\u30d5\u30a7\u30fc\u30b9<\/span><\/h2>\n<p>\u7121\u4e8b\u3001\u30c7\u30fc\u30bf\u30b9\u30c8\u30a2\u306bsession\u3092\u4fdd\u5b58\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3088\u3046\u306b\u306a\u3063\u305f\u306e\u3067\u3001\u5b9f\u969b\u306b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5185\u90e8\u3067\u4f7f\u3063\u3066\u307f\u305f\u3044\u3068\u601d\u3044\u307e\u3059\u3002MojoX::Session\u3092\u4f7f\u3046\u5834\u5408\u3001startup\u306e\u4e2d\u3067\u4e0b\u8a18\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u307e\u3059\u3002<\/p>\n<pre lang=\"perl\">\r\n    $self->plugin(\r\n        session => {\r\n            stash_key => 'mojox-session',\r\n            store     => MojoX::Session::Store::Redis->new(\r\n                {\r\n                    server  => '127.0.0.1:6379',\r\n                    redis_prefix    => 'mojo-session',\r\n                    redis_dbid      => 1,\r\n                }\r\n            ),\r\n            expires_delta => 3600,\r\n        }\r\n    );\r\n<\/pre>\n<p>\u305d\u3046\u3059\u308b\u3068\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5185\u3067\u306f\u3053\u3093\u306a\u611f\u3058\u306b\u306a\u308a\u307e\u3059\u3002<\/p>\n<pre lang=\"perl\">\r\nmy $session = $self->stash('mojox-session');\r\n$session->load;\r\n$session->create unless $session->sid;\r\n#set \r\n$session->data(\r\n    id => 5,\r\n    name => 'hoge',\r\n);\r\n#get\r\nmy $name = $session->data('name');\r\n<\/pre>\n<h2><span id=\"Helper\">Helper<\/span><\/h2>\n<p>session\u3092\u53d6\u308a\u51fa\u3059\u306e\u306bstash\u95a2\u6570\u3092\u76f4\u306b\u4f7f\u3046\u306e\u3082\u30c0\u30b5\u3044\u3057\u3001\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306b\u81ea\u5206\u3067load\u3057\u305f\u308a\u3059\u308b\u306e\u3082\u306a\u3093\u3060\u304b\u306a\u3041\u3068\u601d\u3063\u305f\u306e\u3067\u7c21\u5358\u306aHelper\u3092\u5b9f\u88c5\u3057\u307e\u3057\u305f\u3002<\/p>\n<pre lang=\"perl\">\r\nuse strict;\r\nuse warnings;\r\nuse utf8;\r\n\r\npackage Hoge::Mojolicious::Plugin::SessionHelper;\r\nuse Mojo::Base 'Mojolicious::Plugin';\r\n\r\nsub register {\r\n    my ($self, $app, $conf) = @_; \r\n    $conf ||= {}; \r\n    $conf->{stash_key} ||= 'mojox-session';\r\n\r\n    my $stash_key = $conf->{stash_key};\r\n\r\n    $app->hook(\r\n        before_dispatch => sub {\r\n            my $self = shift;\r\n            my $session = $self->stash( $stash_key );\r\n            $session->load;\r\n            $session->create unless $session->sid;\r\n\r\n            $self->stash()\r\n        }   \r\n    );  \r\n\r\n    $app->helper( sessions => sub { shift->stash($stash_key); } );\r\n}\r\n\r\n1;\r\n<\/pre>\n<p>\u3053\u308c\u3067\u3001\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u5185\u90e8\u3067\u306f\u3053\u3093\u306a\u611f\u3058\u3067\u66f8\u3051\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002<\/p>\n<pre lang=\"perl\">\r\n#set\r\n$self->sessions->data(\r\n    id => 5,\r\n    name => 'hoge',\r\n);\r\n#get\r\nmy $name = $self->sessions->data('name');\r\n<\/pre>\n<p>\u30ea\u30af\u30a8\u30b9\u30c8\u6bce\u306bload\u306a\u3069\u3082\u3057\u306a\u3044\u3067\u826f\u3044\u3057\u3001\u30bb\u30c3\u30b7\u30e7\u30f3\u7528\u306eAPI\u3082\u7528\u610f\u3059\u308b\u3053\u3068\u3067\u898b\u305f\u76ee\u3082\u3059\u3063\u304d\u308a\u3059\u308b\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002\u672c\u5f53\u306f$self->session->data(&#8216;name&#8217;)\u307f\u305f\u3044\u306a\u611f\u3058\u3067\u66f8\u3051\u308b\u3068\u826f\u304b\u3063\u305f\u3093\u3067\u3059\u304csession\u30e1\u30bd\u30c3\u30c9\u306fMojolicious::Controller\u306b\u65e2\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002<\/p>\n<p>MojoX::Session\u3082\u5143\u3005\u5b58\u5728\u3059\u308bMojolicious::Controller::session\u30e1\u30bd\u30c3\u30c9\u306f\u5229\u7528\u3057\u3066\u3044\u306a\u3044\u306e\u3067\u3001\u30d5\u30c3\u30af\u3057\u306b\u304f\u3044\u69cb\u9020\u306b\u306a\u3063\u3066\u3044\u308b\u306e\u304b\u3082\u3057\u308c\u306a\u3044\u3002\u305b\u3063\u304b\u304f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067API\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u308b\u306e\u3060\u304b\u3089\u3053\u308c\u3092\u4e0a\u624b\u304f\u5229\u7528\u3057\u305f\u3044\u3057\u3001\u305d\u306e\u65b9\u304c\u308f\u304b\u308a\u3084\u3059\u3044\u3060\u308d\u3046\u3002<\/p>\n<p>\u305d\u306e\u8fba\u306e\u8a71\u306f\u307e\u305f\u4eca\u5ea6\u3002\u4eca\u56de\u306f\u3068\u308a\u3042\u3048\u305a\u3053\u306e\u5b9f\u88c5\u3067\u3084\u3063\u3066\u307f\u308b\u3002<\/p>\n<p><strong>\u8ffd\u8a18\uff1a2012.11.14<\/strong><br \/>\n<a href=\"https:\/\/fukata.org\/2012\/11\/11\/available-mojox-session-store-redis\/\" title=\"MojoX::Session::Store::Redis\u304c\u52d5\u304f\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01\">MojoX::Session::Store::Redis\u304c\u52d5\u304f\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\uff01<\/a>\u3067Merge\u3055\u308c\u3066\u7121\u4e8b\u52d5\u304f\u3088\u3046\u306b\u306a\u308a\u307e\u3057\u305f\u3002<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Mojolicious\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u3067\u306fcookie\u306bbase64\u5316\u3057\u305f\u6587\u5b57\u5217\u3092\u683c\u7d0d\u3057\u3066\u3044\u307e\u3059\u3002\u305d\u306e\u305f\u3081\u30014kb\u306e\u5236\u9650\u3084\u6bce\u56de\u3059\u3079\u3066\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\u30c7\u30fc\u30bf\u3092\u9001\u308b\u3053\u3068\u306b\u306a\u3063\u305f\u308a\u3068\u8272\u3005\u3088\u308d\u3057\u304f\u306a\u3044\u3068\u3053 &#8230; <a href=\"https:\/\/blog.fukata.org\/archives\/7292\/\"> \u7d9a\u304d\u3092\u8aad\u3080<\/a><\/p>\n","protected":false},"author":2,"featured_media":9223372036854775807,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[1980],"tags":[978,1010],"_links":{"self":[{"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/posts\/7292"}],"collection":[{"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/comments?post=7292"}],"version-history":[{"count":0,"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/posts\/7292\/revisions"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/media\/9223372036854775807"}],"wp:attachment":[{"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/media?parent=7292"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/categories?post=7292"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/blog.fukata.org\/wp-json\/wp\/v2\/tags?post=7292"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}